<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Clemens&#39; blog</title>
  <meta name="author" content="Clemens Valiente">
  
  <meta name="description" content="A blog that mostly covers experiences with the hadoop architecture">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Clemens&#39; blog"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="Clemens&#39; blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">Clemens&#39; blog</a></h1>
  <h2><a href="/">short messages from the world of hadoop</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-12-11T22:05:08.000Z"><a href="/2015/12/11/hive-median-ci/">2015-12-11</a></time>
      
      
  
    <h1 class="title"><a href="/2015/12/11/hive-median-ci/">Calculating confidence intervals for median on Hive</a></h1>
  

    </header>
    <div class="entry">
      
        <h2 id="Isnitial_Question"><a href="#Isnitial_Question" class="headerlink" title="Isnitial Question"></a>Isnitial Question</h2><p>At trivago, we are generating price-related statistics using billions of logged entries every day containing information provided by third parties. This can get quite messy, as you can easily find hotel prices at one million Euro and above in that huge dataset. In order to avoid having these extreme outliers - bugs in the implementation, invalid requests or however they may occur - we decided that in the future, want to show the median price of a hotel instead of the mean as we used to do (when we still had a much smaller dataset that was much easier to clean and control). One valid question during the transition was:<br>“How much data do I need to have a reliable median information?”</p>
<h2 id="Approach"><a href="#Approach" class="headerlink" title="Approach"></a>Approach</h2><p>For the mean, SQL and also Hive already provide tools that help answering that question - e.g <code>stddev_samp</code> and <code>variance</code> as part of the <a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+UDF#LanguageManualUDF-Built-inAggregateFunctions(UDAF" target="_blank" rel="external">Hive UDAFs</a>). Providing a confidence interval for your mean value is quite straightforward and also easy to understand for the unitiated. A 95% confidence interval is the interval, in which the “real” mean value lies with a confidence of 95%. I did some quick research (meaning, I googled) and found the following article discussing how to calculate the confidence interval of the median: <a href="https://epilab.ich.ucl.ac.uk/coursematerial/statistics/non_parametric/confidence_interval.html" target="_blank" rel="external">https://epilab.ich.ucl.ac.uk/coursematerial/statistics/non_parametric/confidence_interval.html</a></p>
<h2 id="Formula"><a href="#Formula" class="headerlink" title="Formula"></a>Formula</h2><p>The formula itself is quite simple. The upper and lower bounds of our confidence interval is the \(u\)th and \(l\)th element of our (sorted) list of size \(n\), with </p>
<p>$$<br>u = 1 + \frac{n}{2} + \left(N_{1-\alpha/2} * \frac{\sqrt{n}}{2}\right)<br>$$</p>
<p>and</p>
<p>$$<br>l = \frac{n}{2} - \left(N_{1-\alpha/2} * \frac{\sqrt{n}}{2}\right)<br>$$</p>
<p>both rounded to the nearest integer. Substitute \(N_{1-\alpha/2}\) with the value from the standard normal distribution of the \(p\)th percentile for a confidence of \(p\), you can use a table of the normal distribution for this (e.g. at <a href="http://www.wolframalpha.com/input/?i=Table%5BSqrt%282%29*InverseErf%28x%29%2C+{x%2C+N%28{8%2F10%2C+9%2F10%2C+19%2F20%2C+49%2F50%2C+99%2F100%2C+995%2F1000%2C+998%2F1000}%2C+13%29}%5D" target="_blank" rel="external">Wolfram Alpha</a>). I want a 95% confidence, so I am going to use 1.96 in the example below.</p>
<h2 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h2><p>Luckily Hive - starting with version 0.14 which includes <a href="https://issues.apache.org/jira/browse/HIVE-7325" target="_blank" rel="external">HIVE-7325</a>- already offers all the functions we need to implement this.<br>We need to collect all the elements, sort them, and then pick element \(l\) and \(u\). This can be done this way:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">WITH cte AS (</span><br><span class="line">	<span class="operator"><span class="keyword">SELECT</span> </span><br><span class="line">		item_id, </span><br><span class="line">		percentile(price,<span class="number">0.5</span>) <span class="keyword">AS</span> <span class="keyword">median</span>,</span><br><span class="line">		sort_array(collect_list(price)) <span class="keyword">AS</span> price_array,</span><br><span class="line">		<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">AS</span> num_prices</span><br><span class="line">	<span class="keyword">FROM</span> </span><br><span class="line">		item_price_found_daily</span><br><span class="line">	<span class="keyword">WHERE</span> </span><br><span class="line">		ymd = <span class="number">20151210</span> </span><br><span class="line">	<span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">		item_id)</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">	item_id,</span><br><span class="line">	<span class="keyword">median</span>/<span class="number">100</span> <span class="keyword">AS</span> <span class="keyword">median</span>,</span><br><span class="line">	num_prices,</span><br><span class="line">	num_prices/<span class="number">2</span>-<span class="number">1.96</span>/<span class="number">2</span>*<span class="keyword">sqrt</span>(num_prices) <span class="keyword">AS</span> lower_l,</span><br><span class="line">	price_array[<span class="keyword">greatest</span>(<span class="keyword">cast</span>(num_prices/<span class="number">2</span>-<span class="number">1.96</span>/<span class="number">2</span>*<span class="keyword">sqrt</span>(num_prices) <span class="keyword">AS</span> <span class="built_in">int</span>)-<span class="number">1</span>,<span class="number">0</span>)]/<span class="number">100</span> <span class="keyword">AS</span> lower_bound,</span><br><span class="line">	<span class="number">1</span>+num_prices/<span class="number">2</span>+<span class="number">1.96</span>/<span class="number">2</span>*<span class="keyword">sqrt</span>(num_prices) <span class="keyword">AS</span> upper_u,</span><br><span class="line">	price_array[<span class="keyword">least</span>(<span class="keyword">cast</span>(<span class="number">1</span>+num_prices/<span class="number">2</span>+<span class="number">1.96</span>/<span class="number">2</span>*<span class="keyword">sqrt</span>(num_prices) <span class="keyword">AS</span> <span class="built_in">int</span>)-<span class="number">1</span>,<span class="keyword">cast</span>(num_prices-<span class="number">1</span> <span class="keyword">AS</span> <span class="built_in">int</span>))]/<span class="number">100</span> <span class="keyword">AS</span> upper_bound,</span><br><span class="line">	price_array</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	cte</span></span><br></pre></td></tr></table></figure>
<p>In the <code>cte</code> part we do the counting, collecting and sorting. Afterwards we access our price_array by the position of the elemnt we want.<br>We need some casting so everything is the correct type, and an additional least/greatest so the returned value stays within the bounds of the array (for very low \(n\), \(l\) and \(u\) can be smaller than 1 or greater than \(n\). Since the array position in Hive starts at 0, we also need to substract 1.<br>Hive is actually able to execute this in one mapreduce stage, but of course you need to store and sort through all your elements in one list, so it will need a lot of memory for this operation if your lists grow large. You might want to do sampling to reduce the size and get an approximation instead of an exact solution.</p>
<h2 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h2><p>The confidence interval now gives us valuable information on how reliable our median is: Even at just one hundred prices the confidence interval often still is very small, since hotel prices often are within a very small range once all the outliers are excluded (as the median does by nature). As expected, the upper boundary usually is a bit further away from the median than the lower boundary.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




  <article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2015-12-11T22:05:08.000Z"><a href="/2015/12/11/setup-hexo/">2015-12-11</a></time>
      
      
  
    <h1 class="title"><a href="/2015/12/11/setup-hexo/">How to set up hexo on github.io</a></h1>
  

    </header>
    <div class="entry">
      
        <p>In my first post on this blog I am going to explain how I set it up in the first place.</p>
<p>I chose to use <a href="https:/hexo.io" target="_blank" rel="external">hexo.io</a> on <a href="https://pages.github.com/" target="_blank" rel="external">Github Pages</a>.<br>This allows me to write my posts in <a href="https://help.github.com/articles/markdown-basics/" target="_blank" rel="external">markdown</a> language and deploy them using git.</p>
<h2 id="resources"><a href="#resources" class="headerlink" title="resources"></a>resources</h2><p>For the most part I followed Jamie Paton’s <a href="http://jdpaton.github.io/2012/11/05/setup-hexo/" target="_blank" rel="external">guide</a>. Since it is a couple of years old by now, a few things have to be done differently.<br>I am going to assume you are running ubuntu or a similar distribution of Linux. All the following commands are to be issued in your terminal.</p>
<h2 id="installation_of_prerequisites"><a href="#installation_of_prerequisites" class="headerlink" title="installation of prerequisites"></a>installation of prerequisites</h2><p>As already outlined in the <a href="https://hexo.io/docs/index.html" target="_blank" rel="external">hexo docs</a>, you need <a href="http://nodejs.org/" target="_blank" rel="external">Node.js</a> and <a href="http://git-scm.com/" target="_blank" rel="external">Git</a>.<br>You might already have git, otherwise install it with</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install git</span><br></pre></td></tr></table></figure>
<p>For the installation of Node.js, hexo (and I) recommend <a href="https://github.com/creationix/nvm" target="_blank" rel="external">nvm</a>. Get it via:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -qO- http<span class="variable">s:</span>//raw.githubusercontent.<span class="keyword">com</span>/creationix/nvm/v0.<span class="number">29.0</span>/install.<span class="keyword">sh</span> | bash</span><br></pre></td></tr></table></figure>
<p>then install Node.js via</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nvm <span class="keyword">install</span> <span class="number">5.2</span></span><br></pre></td></tr></table></figure>
<p>5.2.0 is the latest (stable) version as of the time of this post. You can also choose the LTS version instead (4.2.3)</p>
<h2 id="install_hexo"><a href="#install_hexo" class="headerlink" title="install hexo"></a>install hexo</h2><p>Now you can install hexo!</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="operator"><span class="keyword">install</span> -<span class="keyword">g</span> hexo-cli</span></span><br></pre></td></tr></table></figure>
<p>Go to the directory where you want to store your project in, and initialise hexo via</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo init username<span class="class">.github</span><span class="class">.io</span></span><br><span class="line">cd username<span class="class">.github</span><span class="class">.io</span></span><br></pre></td></tr></table></figure>
<p>As suggested by Jamie, now is a good time to set up a few general things like title and author:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">vim</span> _<span class="tag">config</span><span class="class">.yml</span></span><br></pre></td></tr></table></figure>
<p>Feel free to use gedit, sublime or the text editor of your choise instead of vim. You can find the documentation of the settings <a href="http://hexo.io/docs/configuration.html" target="_blank" rel="external">here</a>.<br>Add the entries for the github deployment:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">deploy</span>:</span><br><span class="line">  <span class="attribute">type</span>: git</span><br><span class="line">  <span class="attribute">repository</span>: <span class="attribute">https</span>:<span class="comment">//github.com/username/username.github.com.git</span></span><br><span class="line">  <span class="attribute">branch</span>: master</span><br></pre></td></tr></table></figure>
<p>If you set up ssh authentication for github, you can also use the ssh URL here.<br>You also need to install the plugin that allows hexo to deploy to git:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="operator"><span class="keyword">install</span> hexo-deployer-git <span class="comment">--save</span></span></span><br></pre></td></tr></table></figure>
<p>If you are using multiple accounts on github with ssh, and you need some additional configuration to identify the correct one for deployment, the git repository is set up in .deploy_git in your hexo directory.</p>
<h2 id="set_up_github"><a href="#set_up_github" class="headerlink" title="set up github"></a>set up github</h2><p>For Github Pages, set up a new repository on your github account named username.github.io - it is important that the username matches your github username.</p>
<h2 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h2><p>You are almost finished! To deploy hexo on your github page, use</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">hexo</span> generate</span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure>
<p>or just <code>hexo generate -d</code>. You can now find your blog at <a href="https://username.github.io" target="_blank" rel="external">https://username.github.io</a><br>You will notice that hexo automatically added a “hello world” first blog. You might want to get rid of that one before you announce your blog.<br>Delete <code>./source/_posts/hello_world.md</code>, and then run <code>hexo clean</code> followed by <code>hexo generate -d</code></p>
<h2 id="themes"><a href="#themes" class="headerlink" title="themes"></a>themes</h2><p>There are already quite a lot of <a href="https://hexo.io/themes/" target="_blank" rel="external">themes</a> for hexo, and if you don’t like any of them you can also create your own.<br>When I set up my blog, it came with the default theme landscape which I didn’t like much, so I switched to <a href="https://hexo.io/hexo-theme-light/" target="_blank" rel="external">“light”</a>.</p>
<h2 id="write_a_post"><a href="#write_a_post" class="headerlink" title="write a post"></a>write a post</h2><p>To create a new blog post, use<br><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="built_in">new</span> <span class="built_in">post</span> &lt;title&gt;</span><br></pre></td></tr></table></figure></p>
<p>then edit the file in <code>./source/_posts/&lt;title&gt;.md</code><br>After finishing your article, run <code>hexo generate -d</code> again to deploy the new article on your blog!</p>
<p>Thanks a lot to Jamie again for the excellent initial guide!</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>





<nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav></div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:cvaliente.github.io">
  </form>
</div>

  

  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/blog/">blog</a><small>1</small></li>
  
    <li><a href="/tags/confidence-interval/">confidence interval</a><small>1</small></li>
  
    <li><a href="/tags/github/">github</a><small>1</small></li>
  
    <li><a href="/tags/hexo/">hexo</a><small>1</small></li>
  
    <li><a href="/tags/hive/">hive</a><small>1</small></li>
  
    <li><a href="/tags/median/">median</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2015 Clemens Valiente
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>


<script type="text/javascript">
var disqus_shortname = 'clemensvaliente';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>